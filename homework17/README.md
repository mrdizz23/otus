>Забрал таблицу **`products`** и запрос с JOIN из ДЗ №13

```
mysql> CREATE TABLE products (
    ->     id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    ->     title VARCHAR(32) NOT NULL,
    ->     category VARCHAR(32) NOT NULL,
    ->     price INT NOT NULL,
    ->     rating INT,
    ->     status VARCHAR(32) NOT NULL
    -> );
Query OK, 0 rows affected (0.02 sec)
```
```
mysql> CALL PopulateProducts(100000, 'Напитки,Консервы,Орехи,Овощи,Мясо,Колбасы,Бакалея');
Query OK, 1 row affected (51.14 sec)
```
```
mysql> SELECT *
    ->   FROM products
    ->   LIMIT 10;
+----+---------------+----------------+-------+--------+--------------------+
| id | title         | category       | price | rating | status             |
+----+---------------+----------------+-------+--------+--------------------+
|  1 | Товар #0      | Мясо           |  1222 |      5 | В наличии          |
|  2 | Товар #1      | Мясо           |  1085 |      4 | Распродан          |
|  3 | Товар #2      | Напитки        |   590 |      3 | Распродан          |
|  4 | Товар #3      | Мясо           |   982 |      4 | В наличии          |
|  5 | Товар #4      | Орехи          |   315 |      4 | Распродан          |
|  6 | Товар #5      | Овощи          |   680 |      1 | Распродан          |
|  7 | Товар #6      | Колбасы        |   697 |      3 | Распродан          |
|  8 | Товар #7      | Колбасы        |   921 |      3 | Распродан          |
|  9 | Товар #8      | Мясо           |   454 |      5 | В наличии          |
| 10 | Товар #9      | Мясо           |  1329 |      2 | В наличии          |
+----+---------------+----------------+-------+--------+--------------------+
10 rows in set (0.00 sec)

mysql> select count(*) from products;
+----------+
| count(*) |
+----------+
|   100000 |
+----------+
1 row in set (0.01 sec)

```

### 1. Построение планов запроса с EXPLAIN

```
mysql> explain SELECT
    ->     t_max.title,
    ->     p.category,
    ->     p.max_price
    -> FROM (
    ->     SELECT
    ->         category,
    ->         MAX(price) AS max_price
    ->     FROM
    ->         products
    ->     GROUP BY
    ->         category
    -> ) p
    -> JOIN products t_max ON p.category = t_max.category AND p.max_price = t_max.price
    -> ;
+----+-------------+------------+------------+------+---------------+-------------+---------+--------------------------------------+-------+----------+-----------------+
| id | select_type | table      | partitions | type | possible_keys | key         | key_len | ref                                  | rows  | filtered | Extra           |
+----+-------------+------------+------------+------+---------------+-------------+---------+--------------------------------------+-------+----------+-----------------+
|  1 | PRIMARY     | t_max      | NULL       | ALL  | NULL          | NULL        | NULL    | NULL                                 | 99614 |   100.00 | NULL            |
|  1 | PRIMARY     | <derived2> | NULL       | ref  | <auto_key0>   | <auto_key0> | 135     | test.t_max.category,test.t_max.price |    10 |   100.00 | Using index     |
|  2 | DERIVED     | products   | NULL       | ALL  | NULL          | NULL        | NULL    | NULL                                 | 99614 |   100.00 | Using temporary |
+----+-------------+------------+------------+------+---------------+-------------+---------+--------------------------------------+-------+----------+-----------------+
3 rows in set, 1 warning (0.01 sec)
```

```
mysql> explain format=TREE SELECT
    ->     t_max.title,
    ->     p.category,
    ->     p.max_price
    -> FROM (
    ->     SELECT
    ->         category,
    ->         MAX(price) AS max_price
    ->     FROM
    ->         products
    ->     GROUP BY
    ->         category
    -> ) p
    -> JOIN products t_max ON p.category = t_max.category AND p.max_price = t_max.price
    -> ;
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                                                                                                                                                                                                           |
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Nested loop inner join  (cost=259143 rows=0)
    -> Table scan on t_max  (cost=10098 rows=99614)
    -> Covering index lookup on p using <auto_key0> (category=t_max.category, max_price=t_max.price)  (cost=0.25..2.5 rows=10)
        -> Materialize  (cost=0..0 rows=0)
            -> Table scan on <temporary>
                -> Aggregate using temporary table
                    -> Table scan on products  (cost=10098 rows=99614)
 |
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.01 sec)
```

```
mysql> explain analyze SELECT
    ->     t_max.title,
    ->     p.category,
    ->     p.max_price
    -> FROM (
    ->     SELECT
    ->         category,
    ->         MAX(price) AS max_price
    ->     FROM
    ->         products
    ->     GROUP BY
    ->         category
    -> ) p
    -> JOIN products t_max ON p.category = t_max.category AND p.max_price = t_max.price
    -> ;
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Nested loop inner join  (cost=259143 rows=0) (actual time=53..105 rows=49 loops=1)
    -> Table scan on t_max  (cost=10098 rows=99614) (actual time=0.778..15.6 rows=100000 loops=1)
    -> Covering index lookup on p using <auto_key0> (category=t_max.category, max_price=t_max.price)  (cost=0.25..2.5 rows=10) (actual time=819e-6..819e-6 rows=490e-6 loops=100000)
        -> Materialize  (cost=0..0 rows=0) (actual time=51.4..51.4 rows=7 loops=1)
            -> Table scan on <temporary>  (actual time=51.1..51.1 rows=7 loops=1)
                -> Aggregate using temporary table  (actual time=51.1..51.1 rows=7 loops=1)
                    -> Table scan on products  (cost=10098 rows=99614) (actual time=0.122..21.9 rows=100000 loops=1)
 |
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.11 sec)
```
>Вариант с filter=JSON прикладывать не буду из-за слишком большого листина

### 2. Анализ планов и выявление слабых мест

Table scan on products: запрос выполняет полное сканирования таблицы, что негативно влияет на производительность. Необходми добавить составной индекс по полям category и price

```
mysql> CREATE INDEX idx_category_price ON products(category, price);
Query OK, 0 rows affected (0.15 sec)
Records: 0  Duplicates: 0  Warnings: 0

```

Смотрим новый explain

```
mysql> explain analyze SELECT
    ->     t_max.title,
    ->     p.category,
    ->     p.max_price
    -> FROM (
    ->     SELECT
    ->         category,
    ->         MAX(price) AS max_price
    ->     FROM
    ->         products
    ->     GROUP BY
    ->         category
    -> ) p
    -> JOIN products t_max ON p.category = t_max.category AND p.max_price = t_max.price
    -> ;
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Nested loop inner join  (cost=21.1 rows=50.8) (actual time=0.189..0.376 rows=49 loops=1)
    -> Filter: (p.max_price is not null)  (cost=9.17..3.29 rows=7) (actual time=0.139..0.141 rows=7 loops=1)
        -> Table scan on p  (cost=10.5..12.7 rows=7) (actual time=0.137..0.139 rows=7 loops=1)
            -> Materialize  (cost=10.1..10.1 rows=7) (actual time=0.135..0.135 rows=7 loops=1)
                -> Covering index skip scan for grouping on products using idx_category_price  (cost=9.45 rows=7) (actual time=0.0526..0.118 rows=7 loops=1)
    -> Index lookup on t_max using idx_category_price (category=p.category, price=p.max_price)  (cost=1.92 rows=7.25) (actual time=0.0298..0.0325 rows=7 loops=7)
 |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
```

